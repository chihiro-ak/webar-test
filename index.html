<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>

<body style="margin:0; overflow:hidden;">

  <a-scene
    mindar-image="imageTargetSrc: targets.mind; smoothing: true; filterMinCF:0.0001; filterBeta: 0.001"
    vr-mode-ui="enabled: false"
    color-space="sRGB"
    device-orientation-permission-ui="enabled: false"
  >

    <!-- ========== targetIndex: 0（瞬き） ========== -->
    <a-entity id="target0" mindar-image-target="targetIndex: 0">
      <a-plane
        id="blinkPlane"
        src="images/01.webp"
        position="0 0 0.02"
        scale="0.9 0.9 1"
        width="1"
        height="1"
        transparent="true"
      ></a-plane>
    </a-entity>

    <!-- ========== targetIndex: 1（静止画・60度立ち上げ） ========== -->
    <a-entity id="target1" mindar-image-target="targetIndex: 1">
      <a-plane
        id="staticPlane"
        src="images/2.webp"
        width="1"
        height="1"
        position="0 0.05 0"
        scale="0.9 0.9 1"
        rotation="40 0 0"
        transparent="true"
      ></a-plane>
    </a-entity>

    <a-camera position="0 0 0"></a-camera>
  </a-scene>

  <script>
  window.addEventListener("DOMContentLoaded", async () => {

    /* ===== preload helper ===== */
    function preloadImages(urls) {
      return Promise.all(
        urls.map(src => new Promise(resolve => {
          const img = new Image();
          img.src = src;
          img.onload = resolve;
        }))
      );
    }

    /* ========= target 0（瞬きアニメ） ========= */

    const target0 = document.querySelector("#target0");
    const blinkPlane = document.querySelector("#blinkPlane");

    const blinkFrames = [
      "images/01.webp",
      "images/02.webp",
      "images/03.webp",
      "images/04.webp",
      "images/05.webp",
      "images/04.webp",
      "images/03.webp",
      "images/02.webp",
      "images/01.webp"
    ];

    await preloadImages(blinkFrames);

    let frameTimer = null;
    let blinkLoopTimer = null;
    let frameIndex = 0;

    const frameInterval = 70;   // フレーム速度（瞬きの速さ）
    const blinkInterval = 2000; // 瞬きの間隔（←これが重要）

    function playBlinkOnce() {
      frameIndex = 0;
      blinkPlane.setAttribute("src", blinkFrames[0]);

      frameTimer = setInterval(() => {
        frameIndex++;
        if (frameIndex >= blinkFrames.length) {
          clearInterval(frameTimer);
          frameTimer = null;
          return;
        }
        blinkPlane.setAttribute("src", blinkFrames[frameIndex]);
      }, frameInterval);
    }

    function startBlinkLoop() {
      if (blinkLoopTimer) return;

      playBlinkOnce();
      blinkLoopTimer = setInterval(playBlinkOnce, blinkInterval);
    }

    function stopBlinkLoop() {
      if (blinkLoopTimer) {
        clearInterval(blinkLoopTimer);
        blinkLoopTimer = null;
      }
      if (frameTimer) {
        clearInterval(frameTimer);
        frameTimer = null;
      }
      frameIndex = 0;
    }

    target0.addEventListener("targetFound", () => {
      startBlinkLoop();
    });

    target0.addEventListener("targetLost", () => {
      stopBlinkLoop();
    });

    /* ========= target 1（静止画） ========= */

    const target1 = document.querySelector("#target1");
    const staticPlane = document.querySelector("#staticPlane");
    const staticImage = "images/2.webp";

    await preloadImages([staticImage]);

    target1.addEventListener("targetFound", () => {
      staticPlane.setAttribute("src", staticImage);
    });

  });
  </script>


</body>
</html>
